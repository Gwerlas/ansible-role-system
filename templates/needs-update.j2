#!/usr/bin/env bash
#
# {{ ansible_managed }}
#
# Detection script to determine if the package manager cache need to be updated
#
# Return codes :
#
# 0 = Do not need to update cache
# 1 = Need updating

set -e

{% if packages_update_policy.marker is defined %}
test_file() {
  test -f "$1"

  # pkgcache age
  local mtime=$(stat --printf '%y' "$1")
  local ts=$(date +%s -d "$mtime")

  test $ts -gt $(date +%s -d '{{ system_packages_cache_age }} days ago')
}

test_file "{{ packages_update_policy.marker }}"
{% endif %}

{% if packages_update_policy.path is defined %}
test_dir() {
  test $(ls -1 "$1" | wc -l) -gt 0

  local matches=$(find "$1" -mtime -{{ system_packages_cache_age + 1 }} | wc -l)
  test $matches -gt 0  
}

test_dir "{{ packages_update_policy.path }}"
{% endif %}
