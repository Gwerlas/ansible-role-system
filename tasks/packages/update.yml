---
- name: Packages - Cache update detection script
  become: true
  ansible.builtin.template:
    src: needs-update.j2
    dest: "{{ system_bin_path }}/needs-update"
    mode: "0755"

- name: Packages - Cache update detection
  ansible.builtin.command:
    cmd: needs-update
  register: result
  failed_when: result.rc > 1
  changed_when: false

- name: Packages - DB update
  when: result.rc == 1
  ansible.builtin.include_tasks:
    file: "{{ upd_task }}"
  with_first_found:
    - files:
        - "{{ ansible_pkg_mgr }}.yml"
        - other.yml
      paths:
        - "{{ role_path }}/tasks/packages/update"
  loop_control:
    loop_var: upd_task
