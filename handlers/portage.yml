---
- name: Portage - Prevent circular dependencies and multilib compilation failures
  listen:
    - change profile
  become: true
  when: is_desktop
  environment:
    USE: minimal
  community.general.portage:
    oneshot: true
    getbinpkg: true
    newuse: true
    package:
      - sys-libs/glibc
      - sys-devel/gcc
      - dev-lang/rust{{ system_portage_use_bin_suffix | ternary('-bin', '') }}
      - dev-python/setuptools
      - media-libs/libsndfile

- name: Portage - Rebuild packages that need to be rebuilt
  listen:
    - change profile
    - emerge --newuse
  become: true
  community.general.portage:
    deep: true
    newuse: true
    update: "{{ system_packages_upgrade }}"
    package: '@world'

- name: Portage - Clean dependencies
  listen:
    - change profile
    - emerge --newuse
  become: true
  community.general.portage:
    depclean: true

- name: Portage - Kernel modules rebuild
  listen: emerge @module-rebuild
  become: true
  community.general.portage:
    package: '@module-rebuild'
