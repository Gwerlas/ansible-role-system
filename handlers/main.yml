---
- name: Portage
  ansible.builtin.import_tasks: portage.yml

- name: OpenRC
  ansible.builtin.import_tasks: openrc.yml

- name: Package manager update cache
  listen: cache update
  become: true
  ansible.builtin.package:
    sync: "{{ (ansible_pkg_mgr == 'portage') | ternary(true, omit) }}"
    update_cache: "{{ (ansible_pkg_mgr != 'portage') | ternary(true, omit) }}"
  register: result
  until: result.failed == false
  retries: 5

- name: Package manager update marker
  listen: cache update
  when: system_packages_update_policy.marker is defined
  become: true
  ansible.builtin.file:
    path: "{{ system_packages_update_policy.marker }}"
    state: touch
    modification_time: now
    mode: 0644

- name: Restart systemd-logind or hostname services
  listen:
    - restart hostname
    - restart logind
  become: true
  ansible.builtin.service:
    name: "{{ (ansible_service_mgr == 'systemd') | ternary('systemd-logind', 'hostname') }}"
    state: restarted

- name: Grub make configuration
  listen: grub-mkconfig
  become: true
  ansible.builtin.command:
    cmd: grub-mkconfig -o /boot/grub/grub.cfg

- name: Reboot
  listen:
    - grub-mkconfig
    - reboot
  become: true
  ansible.builtin.reboot:
    msg: Reboot initiated by gwerlas.system Ansible role
